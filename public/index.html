<!DOCTYPE html>
<html>
	<head>
		<title>Messages</title>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>

	</head>
	<body>
		<h1>Distributed KNN</h1>
		<canvas id="unknown" width="28" height="28"></canvas>
		<canvas id="classified" width="28" height="28"></canvas>
		<div align="center">
            <canvas id="myCanvas" width="224" height="224" style="border:2px solid black;"></canvas>
            <canvas id="scaledCanvas" width="28" height="28" style="border:2px solid black;"></canvas>
            <br /><br />
            <button onclick="javascript:clearArea();return false;">Clear Area</button>
            <button onclick="javascript:submitArea();return false;">Submit Number</button>
        </div>
        <div>We think your number is: <span id="nearestNeighbors"></span></div>
	</body>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.1/socket.io.js"></script>
	
	<script>
		var socket = io.connect();
		var w;
		var global;
		var canvas = document.getElementById("unknown"); 
		var context = canvas.getContext("2d");
		
		var canvas2 = document.getElementById("classified"); 
		var context2 = canvas2.getContext("2d");
		socket.on('setNearest',function(data){
            var nn = document.getElementById("nearestNeighbors");
            var temp = ""
            for(var i = 0; i < data.length;i++)
            {
                if(data[i] != -1)
                {
                    temp += data[i].classification+", "
                }
            }
            nn.innerHTML = temp;
            
			console.log("updated nn list",data);
		});
		socket.on('number',function(data){
			var imagedata = context.createImageData(28, 28);
			var imagedata2 = context.createImageData(28, 28);

			for(var i =0; i < data[0][0][1].length; i++)
			{
				pixelindex = i*4;
				var color = data[0][0][1][i];
				imagedata.data[pixelindex] = color;
				imagedata.data[pixelindex+1] = color;
				imagedata.data[pixelindex+2] = color;
				imagedata.data[pixelindex+3] = 255;
			}
			context.putImageData(imagedata, 0, 0);

			for(var i =0; i < data[0][1][1].length; i++)
			{
				pixelindex = i*4;
				var color = data[0][1][1][i];
				imagedata2.data[pixelindex] = color;
				imagedata2.data[pixelindex+1] = color;
				imagedata2.data[pixelindex+2] = color;
				imagedata2.data[pixelindex+3] = 255;
			}
			context2.putImageData(imagedata2, 0, 0);

			if(typeof(Worker) !== "undefined") {
				if(typeof(w) == "undefined") {
					w = new Worker("oneMan.js");
					w.postMessage(data);
				}
				w.onmessage = function(event) {
					//console.log(event)
					socket.emit('sendBackToServer',event.data)
					w.terminate();
					w = undefined;
				};

			} else {
				document.getElementById("result").innerHTML = "Sorry, your browser does not support Web Workers...";
			}
		});
	</script>
	<script>
        var mousePressed = false;
        var lastX, lastY;
        var ctx;
        var smallctx;
        function InitThis() {
            ctx = document.getElementById('myCanvas').getContext("2d");
            
            smallctx = document.getElementById('scaledCanvas').getContext("2d");
            $('#myCanvas').mousedown(function (e) {
                mousePressed = true;
                Draw(e.pageX - $(this).offset().left, e.pageY - $(this).offset().top, false);
            });

            $('#myCanvas').mousemove(function (e) {
                if (mousePressed) {
                    Draw(e.pageX - $(this).offset().left, e.pageY - $(this).offset().top, true);
                }
            });

            $('#myCanvas').mouseup(function (e) {
                mousePressed = false;
            });
            $('#myCanvas').mouseleave(function (e) {
                mousePressed = false;
            });
        }

        function Draw(x, y, isDown) {
            if (isDown) {
                ctx.beginPath();
                ctx.strokeStyle = "black";
                ctx.lineWidth = 16;
                ctx.lineJoin = "round";
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.closePath();
                ctx.stroke();
            }
            lastX = x; lastY = y;
            smallctx.drawImage(document.getElementById('myCanvas'), 0, 0, 28, 28)
        }
        function submitArea()
        {
            var imgData = smallctx.getImageData(0,0,28,28);
            //var color []
            img = []
            for(var i = 0 ; i < imgData.data.length; i+=4)
            {
                if(imgData.data[i+3] == 0)
                {
                    img.push(0)
                    //console.log("white")
                }else{
                    img.push(255)
                    //console.log("black")
                }
            }
			socket.emit('addNumber',img)
			
        }
        function clearArea() {
            // Use the identity matrix while clearing the canvas
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            smallctx.setTransform(1, 0, 0, 1, 0, 0);
            smallctx.clearRect(0, 0, smallctx.canvas.width, smallctx.canvas.height);
        }
		InitThis()
    </script>
</html>
